(()=>{"use strict";const w=window,d=document,n=Date.now.bind(Date),WB=w.ASANROOZ_WORKER_BASE||"https://asanrooz-check-captcha.mr-rahimi-kiasari.workers.dev",EP=w.ASANROOZ_MESSAGE_ENDPOINT||`${WB}/api/contact`,TO=2e4,LS_SENDS="asanrooz_contact_sends_v1",LS_QUAR="asanrooz_contact_quarantine_until_v1",TEN=6e5,HOUR=36e5,MSG=Object.freeze({NAME_REQUIRED:"لطفاً نام خود را وارد کنید.",NAME_FA:"لطفا نام خود را به فارسی وارد کنید.",NAME_MIN:"نام وارد شده صحیح نیست.",EMAIL_REQUIRED:"ایمیل خود را وارد کنید.",EMAIL_INVALID:"ایمیل وارد شده صحیح نیست.",MESSAGE_REQUIRED:"پیام خود را وارد کنید.",MESSAGE_MIN:"متن پیام باید حداقل ۳۰ کاراکتر باشد.",MESSAGE_SPAM:"لطفا پیام خود را بصورت صحیح بنویسید.",CAPTCHA_REQUIRED:"لطفا تایید کنید که ربات نیستید!",SEND_FAILED:"مشکلی در روند ارسال پیام رخ داد! لطفا بعدا دوباره امتحان کنید.",SUCCESS_TITLE:"توجه",SUCCESS_TEXT:"پیام شما را دریافت کردیم و به زودی از طریق ایمیل ثبت شده به آن پاسخ خواهیم داد."});const U={ns:s=>String(s||"").replace(/\s+/g," ").trim(),faOnly:s=>/^[\u0600-\u06FF\u200c\s]+$/.test(s),faCount:s=>String(s||"").replace(/[\s\u200c]/g,"").length,emailOk:e=>{const v=String(e||"").trim();if(v.length<7)return!1;const p=v.split("@");if(2!==p.length)return!1;const l=p[0],dom=p[1];if(!l||!dom)return!1;if(-1===dom.indexOf("."))return!1;if(dom.startsWith(".")||dom.endsWith("."))return!1;const dl=dom.toLowerCase();if("codbanoo.ir"===dl||dl.endsWith(".codbanoo.ir"))return!1;if("asanrooz.ir"===dl||dl.endsWith(".asanrooz.ir"))return!1;return!0},cap:()=>{try{if(w.grecaptcha&&"function"==typeof w.grecaptcha.getResponse)return String(w.grecaptcha.getResponse()||"")}catch(e){}return""},capReset:()=>{try{if(w.grecaptcha&&"function"==typeof w.grecaptcha.reset)w.grecaptcha.reset()}catch(e){}},json:t=>{try{return JSON.parse(t)}catch(e){return null}},timeout:(fn,ms)=>{const c=new AbortController,i=setTimeout(()=>c.abort(),ms),p=(async()=>{try{return await fn(c.signal)}finally{clearTimeout(i)}})();return{wrapped:p,controller:c}},meta:()=>{const tz=(()=>{try{return Intl.DateTimeFormat().resolvedOptions().timeZone||""}catch(e){return""}})(),scr=`${w.screen?.width||0}x${w.screen?.height||0}`,vp=`${w.innerWidth||0}x${w.innerHeight||0}`,dm=navigator.deviceMemory?String(navigator.deviceMemory):"",hc=navigator.hardwareConcurrency?String(navigator.hardwareConcurrency):"";let conn="";try{const c=navigator.connection||navigator.mozConnection||navigator.webkitConnection;c&&(conn=[c.effectiveType?`type=${c.effectiveType}`:"","number"==typeof c.downlink?`downlink=${c.downlink}`:"","number"==typeof c.rtt?`rtt=${c.rtt}`:"",c.saveData?"saveData=1":""].filter(Boolean).join(", "))}catch(e){}return{page:String(location.href||""),referrer:String(d.referrer||""),userAgent:String(navigator.userAgent||""),language:String(navigator.language||""),platform:String(navigator.platform||""),timezone:tz,screen:scr,viewport:vp,deviceMemory:dm,hardwareConcurrency:hc,connection:conn,ts:new Date().toISOString()}}};const Store={getArr:k=>{try{const r=localStorage.getItem(k),a=r?JSON.parse(r):[];return Array.isArray(a)?a.filter(x=>"number"==typeof x):[]}catch(e){return[]}},setArr:(k,a)=>{try{localStorage.setItem(k,JSON.stringify(a))}catch(e){}},getNum:k=>{try{const v=Number(localStorage.getItem(k));return Number.isFinite(v)?v:0}catch(e){return 0}},setNum:(k,v)=>{try{localStorage.setItem(k,String(v))}catch(e){}}};const Quar={until:()=>Store.getNum(LS_QUAR),set:t=>Store.setNum(LS_QUAR,t),sends:()=>Store.getArr(LS_SENDS),setSends:a=>Store.setArr(LS_SENDS,a),is:()=>{const u=Quar.until();return!!(u&&u>n())},minsLeft:t=>{const diff=Math.max(0,t-n());return Math.max(1,Math.ceil(diff/6e4))},msg:m=>`برای جلوگیری از شلوغی سرور، هر کاربر نهایتا ۳ پیام میتواند برای ما ارسال کند!\nدر صورتی که قصد ارسال پیام بیشتر دارید می‌توانید ${m} دقیقه دیگر مجدد امتحان کنید یا اینکه با info@asanrooz.ir تماس بگیرید.`,register:()=>{const t=n();let s=Quar.sends().filter(x=>t-x<=2*HOUR);s.push(t),Quar.setSends(s);const last10=s.filter(x=>t-x<=TEN);last10.length>=3&&Quar.set(t+HOUR)}};const SoftLock=(()=>{try{d.addEventListener("contextmenu",e=>e.preventDefault(),{capture:!0}),d.addEventListener("keydown",e=>{const k=(e.key||"").toLowerCase(),ctrl=e.ctrlKey||e.metaKey;if("f12"===k||ctrl&&e.shiftKey&&("i"===k||"j"===k||"c"===k||"k"===k)||ctrl&&"u"===k)return e.preventDefault(),e.stopPropagation(),!1;return!0},!0);try{const noop=()=>{};w.__ASANROOZ_ALLOW_CONSOLE__||(console.log=noop,console.info=noop,console.warn=noop,console.error=noop,console.debug=noop)}catch(e){}}catch(e){}return{}})();const form=d.getElementById("contactForm");if(!form)return;const nameEl=d.getElementById("name"),emailEl=d.getElementById("email"),msgEl=d.getElementById("message"),sendBtn=d.getElementById("sendBtn"),contactSection=d.getElementById("contact"),contactLink=d.getElementById("contactLink");contactLink&&contactSection&&contactLink.addEventListener("click",e=>{e.preventDefault();try{contactSection.scrollIntoView({behavior:"smooth",block:"start"})}catch(t){location.hash="#contact"}});let updateCounter=null,counterEl=null;if(msgEl){counterEl=d.createElement("div"),counterEl.id="msgCounter",counterEl.style.cssText="\n      margin-top: 8px;\n      font-size: .9rem;\n      line-height: 1.6;\n      text-align: left;\n      direction: ltr;\n      user-select: none;\n    ",msgEl.insertAdjacentElement("afterend",counterEl),updateCounter=()=>{const len=(msgEl.value||"").length;counterEl.textContent=`${len} / 30`,counterEl.style.color=len<30?"#F7941D":"#1758C8"},msgEl.addEventListener("input",updateCounter),updateCounter()}const modal=d.getElementById("modal"),modalTitle=d.getElementById("modalTitle"),modalText=d.getElementById("modalText"),modalOk=d.getElementById("modalOk");let afterFocus=null,afterAction=null;const openModal=(title,text,focusEl,afterClose)=>{if(!modal||!modalTitle||!modalText||!modalOk){alert(`${title}\n\n${text}`);return}modalTitle.textContent=title||"پیام",modalText.textContent=String(text||""),afterFocus=focusEl||null,afterAction="function"==typeof afterClose?afterClose:null,modal.classList.remove("is-closing"),modal.classList.add("is-open"),d.documentElement.style.overflow="hidden",d.body.style.overflow="hidden",modalOk.focus()},closeModal=()=>{if(!modal)return;modal.classList.add("is-closing"),setTimeout(()=>{modal.classList.remove("is-open","is-closing"),d.documentElement.style.overflow="",d.body.style.overflow="";if(afterAction){const fn=afterAction;afterAction=null,fn()}else afterFocus&&"function"==typeof afterFocus.focus&&(afterFocus.focus({preventScroll:!0}),contactSection&&(()=>{try{contactSection.scrollIntoView({behavior:"smooth",block:"start"})}catch(e){}})());afterFocus=null},460)};modalOk&&modalOk.addEventListener("click",closeModal),d.addEventListener("keydown",e=>{modal&&modal.classList.contains("is-open")&&("Escape"===e.key||"Esc"===e.key)&&e.preventDefault()});const validate=()=>{const name=U.ns(nameEl?.value),email=String(emailEl?.value||"").trim(),raw=String(msgEl?.value||""),trim=raw.trim();if(!name)return openModal("خطا",MSG.NAME_REQUIRED,nameEl),!1;if(!U.faOnly(name))return openModal("خطا",MSG.NAME_FA,nameEl),!1;if(U.faCount(name)<3)return openModal("خطا",MSG.NAME_MIN,nameEl),!1;if(!email)return openModal("خطا",MSG.EMAIL_REQUIRED,emailEl),!1;if(!U.emailOk(email))return openModal("خطا",MSG.EMAIL_INVALID,emailEl),!1;if(!trim)return openModal("خطا",MSG.MESSAGE_REQUIRED,msgEl),!1;if(trim.length<30)return openModal("خطا",MSG.MESSAGE_MIN,msgEl),!1;const nw=raw.replace(/\s+/g,"");if(0===nw.length)return openModal("خطا",MSG.MESSAGE_SPAM,msgEl),!1;const tok=U.cap();return tok?(!!0):(openModal("خطا",MSG.CAPTCHA_REQUIRED,null),!1)};const isCapErr=data=>{const err=data&&(data.error||data.code)?String(data.error||data.code):"";return"captcha_failed"===err||"missing_captcha"===err};const send=async payload=>{const req=async signal=>{const res=await fetch(EP,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload),signal});const text=await res.text().catch(()=>""),data=U.json(text);if(res.ok){if(data&&(data.success===!0||data.ok===!0))return{ok:!0,data};if(!data)return{ok:!0,data:null}}data&&isCapErr(data)&&U.capReset();const err=new Error("SEND_FAILED");throw err.__server=data||null,err.__status=res.status||0,err};const{wrapped}=U.timeout(req,TO);return await wrapped};form.addEventListener("submit",async e=>{e.preventDefault(),contactSection&&(()=>{try{contactSection.scrollIntoView({behavior:"auto",block:"start"})}catch(t){}})();if(Quar.is()){openModal("خطا",Quar.msg(Quar.minsLeft(Quar.until())),null);return}if(!validate())return;const prev=!!sendBtn?.disabled;sendBtn&&(sendBtn.disabled=!0);try{const token=U.cap(),m=U.meta(),payload={name:U.ns(nameEl?.value),email:String(emailEl?.value||"").trim(),message:String(msgEl?.value||""),captchaToken:token,page:m.page,referrer:m.referrer,userAgent:m.userAgent,language:m.language,platform:m.platform,timezone:m.timezone,screen:m.screen,viewport:m.viewport,deviceMemory:m.deviceMemory,hardwareConcurrency:m.hardwareConcurrency,connection:m.connection,ts:m.ts,source:"asanrooz-landing"};try{await send(payload)}catch(t){openModal("خطا",MSG.SEND_FAILED,null);return}Quar.register(),openModal(MSG.SUCCESS_TITLE,MSG.SUCCESS_TEXT,null,()=>{form.reset(),U.capReset(),"function"==typeof updateCounter?updateCounter():counterEl&&(counterEl.textContent="0 / 30",counterEl.style.color="#F7941D");try{w.scrollTo({top:0,behavior:"smooth"})}catch(t){w.scrollTo(0,0)}})}finally{sendBtn&&(sendBtn.disabled=prev)}})})();